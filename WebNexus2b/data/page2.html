<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consumi Elettrici Istantanei</title>
<script src="/Chart.min.js"></script>
<script>
    // Polyfill per Array.prototype.fill
    if (!Array.prototype.fill) {
        Object.defineProperty(Array.prototype, 'fill', {
            value: function(value) {
                if (this == null) {
                    throw new TypeError('this is null or not defined');
                }
                var O = Object(this);
                var len = O.length >>> 0;
                var start = arguments[1];
                var relativeStart = start >> 0;
                var k = relativeStart < 0 ? Math.max(len + relativeStart, 0) : Math.min(relativeStart, len);
                var end = arguments[2];
                var relativeEnd = end === undefined ? len : end >> 0;
                var final = relativeEnd < 0 ? Math.max(len + relativeEnd, 0) : Math.min(relativeEnd, len);
                while (k < final) {
                    O[k] = value;
                    k++;
                }
                return O;
            }
        });
    }

    // Polyfill per Array.prototype.forEach
    if (!Array.prototype.forEach) {
        Array.prototype.forEach = function(callback, thisArg) {
            var T, k;
            if (this == null) {
                throw new TypeError('this is null or not defined');
            }
            var O = Object(this);
            var len = O.length >>> 0;
            if (typeof callback !== 'function') {
                throw new TypeError(callback + ' is not a function');
            }
            if (arguments.length > 1) {
                T = thisArg;
            }
            k = 0;
            while (k < len) {
                var kValue;
                if (k in O) {
                    kValue = O[k];
                    callback.call(T, kValue, k, O);
                }
                k++;
            }
        };
    }

function calculateAverage(data) {
    if (data.length === 0) return 0;  // Aggiungere questa linea
    var sum = 0;
    for (var i = 0; i < data.length; i++) {
        sum += data[i];
    }
    return sum / data.length;
}


function drawAverageLines(chart, averages, totalAverage) {
    var ctx = chart.ctx;  // Cambiare questa linea
    var chartArea = chart.chartArea;
    var yScale = chart.scales['y-axis-0'];

    // Disegna linee di media per ogni dataset
    for (var i = 0; i < averages.length; i++) {
        var yValue = yScale.getPixelForValue(averages[i]);

        ctx.save();
        ctx.beginPath();
        ctx.moveTo(chartArea.left, yValue);
        ctx.lineTo(chartArea.right, yValue);
        ctx.strokeStyle = chart.data.datasets[i].borderColor;
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.restore();
    }

    // Disegna la linea di media totale
    var yTotalValue = yScale.getPixelForValue(totalAverage);
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(chartArea.left, yTotalValue);
    ctx.lineTo(chartArea.right, yTotalValue);
    ctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';  // Colore per la media totale
    ctx.lineWidth = 2;
    ctx.setLineDash([5, 5]);  // Linea tratteggiata per la media totale
    ctx.stroke();
    ctx.restore();
}


Chart.plugins.register({
    afterDraw: function(chart) {
        var averages = [];
        for (var i = 0; i < chart.data.datasets.length; i++) {
            averages.push(calculateAverage(chart.data.datasets[i].data));
        }

        // Calcola la media totale della somma dei valori delle colonne
        var totalSumData = [];
        for (var j = 0; j < chart.data.labels.length; j++) {
            var totalSum = 0;
            for (var k = 0; k < chart.data.datasets.length; k++) {
                totalSum += chart.data.datasets[k].data[j];
            }
            totalSumData.push(totalSum);
        }
        var totalAverage = calculateAverage(totalSumData);

        drawAverageLines(chart, averages, totalAverage);
    }
});

</script>
</head>
<body>
    <div class="container">
        <header>
            <!-- Include nav.html content -->
            <nav class="row">
                <div class="twelve columns">
                    <ul class="nav-list">
                        <li><a href="/">Istan</a></li>
                        <li><a href="/page1.html">Orari</a></li>
                        <li><a href="/page2.html">Giorn</a></li>
                        <li><a href="/page3.html">--</a></li>
                        <li><a href="/page4.html">--</a></li>
                        <li><a href="/page5.html">Impos</a></li>
                    </ul>
                </div>
            </nav>
            <style>
                .nav-list {
                    list-style: none;
                    padding: 0;
                    margin: 0;
                    display: flex;
                    justify-content: space-around;
                    background-color: #333;
                }
                .nav-list li {
                    display: inline;
                }
                .nav-list li a {
                    display: block;
                    color: white;
                    text-align: center;
                    padding: 14px 16px;
                    text-decoration: none;
                }
                .nav-list li a:hover {
                    background-color: #111;
                }
            </style>
        </header>
        <main>
            <h1>Consumi Elettrici Giornalieri - Wattora (Wh)</h1>
          <div id="lastRadio" style="position: fixed; bottom: 10px; width: 100%; text-align: center; background-color: lightgrey;"></div>
            <canvas id="myChart" width="400" height="200"></canvas>
            <script>
            var ctx = document.getElementById('myChart').getContext('2d');
            var data = {
                labels: new Array(31).fill(''),
                datasets: [
                    {
                        label: 'Energia Attiva',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        data: new Array(31).fill(0)
                    },
                    {
                        label: 'Energia Reattiva',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        data: new Array(31).fill(0)
                    },
                ]
            };

var config = {
    type: 'bar',
    data: data,
    options: {
        responsive: true,
        scales: {
            xAxes: [{
                stacked: true
            }],
            yAxes: [{
                stacked: true,
                id: 'y-axis-0'  // Aggiungere questa linea
            }]
        }
    }
};


            var myChart = new Chart(ctx, config);

            var websocket = new WebSocket('ws://' + location.hostname + ':81/');

            websocket.onopen = function() {
                console.log('WebSocket connection established');
                websocket.send('getDaysEnergy');
            };

            websocket.onmessage = function(event) {
                var message = JSON.parse(event.data);

                if (Object.prototype.toString.call(message) === '[object Array]') {
                    for (var i = 0; i < message.length; i++) {
                        var dataPoint = message[i];
                        myChart.data.labels[i] = dataPoint.timestamp;
                        myChart.data.datasets[0].data[i] = dataPoint.activeEnergy;
                        myChart.data.datasets[1].data[i] = dataPoint.reactiveEnergy;
                    }
                } else {
                    // last RX RADIO
                    var lastRadio = document.getElementById('lastRadio');
                    lastRadio.innerText = message.timestampLong;

                }

                myChart.update();
            };            

            websocket.onclose = function() {
                console.log('WebSocket connection closed');
            };
            </script>
        </main>
    </div>
</body>
</html>
