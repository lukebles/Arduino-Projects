<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP-01 Data Visualization</title>
    <script src="/Chart.min.js"></script>
    <script>
        // Polyfill per Array.prototype.fill
        if (!Array.prototype.fill) {
            Object.defineProperty(Array.prototype, 'fill', {
                value: function(value) {
                    if (this == null) {
                        throw new TypeError('this is null or not defined');
                    }
                    var O = Object(this);
                    var len = O.length >>> 0;
                    var start = arguments[1];
                    var relativeStart = start >> 0;
                    var k = relativeStart < 0 ? Math.max(len + relativeStart, 0) : Math.min(relativeStart, len);
                    var end = arguments[2];
                    var relativeEnd = end === undefined ? len : end >> 0;
                    var final = relativeEnd < 0 ? Math.max(len + relativeEnd, 0) : Math.min(relativeEnd, len);
                    while (k < final) {
                        O[k] = value;
                        k++;
                    }
                    return O;
                }
            });
        }

        // Polyfill per Array.prototype.forEach
        if (!Array.prototype.forEach) {
            Array.prototype.forEach = function(callback, thisArg) {
                var T, k;
                if (this == null) {
                    throw new TypeError('this is null or not defined');
                }
                var O = Object(this);
                var len = O.length >>> 0;
                if (typeof callback !== 'function') {
                    throw new TypeError(callback + ' is not a function');
                }
                if (arguments.length > 1) {
                    T = thisArg;
                }
                k = 0;
                while (k < len) {
                    var kValue;
                    if (k in O) {
                        kValue = O[k];
                        callback.call(T, kValue, k, O);
                    }
                    k++;
                }
            };
        }
    </script>
</head>
<body>
    <div class="container">
        <header>
            <!-- Include nav.html content -->
            <nav class="row">
                <div class="twelve columns">
                    <ul class="nav-list">
                        <li><a href="/">Home</a></li>
                        <li><a href="/page1.html">Pagina 1</a></li>
                        <li><a href="/page2.html">Pagina 2</a></li>
                        <li><a href="/page3.html">Pagina 3</a></li>
                        <li><a href="/page4.html">Pagina 4</a></li>
                        <li><a href="/page5.html">Pagina 5</a></li>
                    </ul>
                </div>
            </nav>
            <style>
                .nav-list {
                    list-style: none;
                    padding: 0;
                    margin: 0;
                    display: flex;
                    justify-content: space-around;
                    background-color: #333;
                }
                .nav-list li {
                    display: inline;
                }
                .nav-list li a {
                    display: block;
                    color: white;
                    text-align: center;
                    padding: 14px 16px;
                    text-decoration: none;
                }
                .nav-list li a:hover {
                    background-color: #111;
                }
            </style>
        </header>
        <main>
            <h1>Consumi elettrici</h1>
            <canvas id="myChart" width="400" height="200"></canvas>
            <script>
        var ctx = document.getElementById('myChart').getContext('2d');
        var data = {
            labels: new Array(31).fill(''),
            datasets: [
                {
                    label: 'Potenza Attiva',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    data: new Array(31).fill(0)
                },
                {
                    label: 'Potenza Reattiva',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    data: new Array(31).fill(0)
                },
                {
                    label: 'Intensita Luminosa',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    data: new Array(31).fill(0)
                }
            ]
        };

        var config = {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                scales: {
                    xAxes: [{
                        stacked: true
                    }],
                    yAxes: [{
                        stacked: true
                    }]
                }
            }
        };

        var myChart = new Chart(ctx, config);

        var websocket = new WebSocket('ws://' + location.hostname + ':81/');

        websocket.onopen = function() {
            console.log('WebSocket connection established');
            websocket.send('getPowerData');
        };

        websocket.onmessage = function(event) {
            var message = JSON.parse(event.data);


if (Object.prototype.toString.call(message) === '[object Array]') {
        for (var i = 0; i < message.length; i++) {
            var dataPoint = message[i];
            myChart.data.labels[i] = dataPoint.timestamp;
            myChart.data.datasets[0].data[i] = dataPoint.activePower;
            myChart.data.datasets[1].data[i] = dataPoint.reactivePower;
            myChart.data.datasets[2].data[i] = dataPoint.lightPower;
        }
    } else {
        myChart.data.labels.push(message.timestamp);
        myChart.data.datasets[0].data.push(message.activePower);
        myChart.data.datasets[1].data.push(message.reactivePower);
        myChart.data.datasets[2].data.push(message.lightPower);

        if (myChart.data.datasets[0].data.length > 31) {
            myChart.data.labels.shift();
            for (var j = 0; j < myChart.data.datasets.length; j++) {
                myChart.data.datasets[j].data.shift();
            }
        }
    }




            // if (Object.prototype.toString.call(message) === '[object Array]') {
            //     var k = 0;
            //     for (var i = 0; i < message.length; i++) {
            //         var dataPoint = message[i];
            //         k = message.length - i - 1;
            //         myChart.data.labels[k] = dataPoint.timestamp;
            //         myChart.data.datasets[0].data[k] = dataPoint.activePower;
            //         myChart.data.datasets[1].data[k] = dataPoint.reactivePower;
            //         myChart.data.datasets[2].data[k] = dataPoint.lightPower;
            //     }
            // } else {
            //     myChart.data.labels.unshift(message.timestamp);
            //     myChart.data.datasets[0].data.unshift(message.activePower);
            //     myChart.data.datasets[1].data.unshift(message.reactivePower);
            //     myChart.data.datasets[2].data.unshift(message.lightPower);

            //     if (myChart.data.labels.length > 31) {
            //         myChart.data.labels.pop();
            //         myChart.data.datasets.forEach(function(dataset) {
            //             dataset.data.pop();
            //         });
            //     }
            // }

            myChart.update();
        };

        websocket.onclose = function() {
            console.log('WebSocket connection closed');
        };
            </script>
        </main>
    </div>
</body>
</html>
