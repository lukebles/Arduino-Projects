<!DOCTYPE html>
<html>
<head>
    <title>ESP01 Chart</title>
    <script src="Chart.min.js"></script>
</head>
<body>
    <h1>Esempio</h1>
    <canvas id="instantChart" width="800" height="400"></canvas>
    <canvas id="hourlyChart" width="800" height="400"></canvas>
    <script>
        var ctx1 = document.getElementById('instantChart').getContext('2d');
        var ctx2 = document.getElementById('hourlyChart').getContext('2d');
        var labels1 = [];
        var data1_1 = [];
        var data1_2 = [];
        var labels2 = [];
        var data2_1 = [];
        var data2_2 = [];

        var instantChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: labels1,
                datasets: [
                    {
                        label: 'Valore 1',
                        data: data1_1,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Valore 2',
                        data: data1_2,
                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                scales: {
                    xAxes: [{
                        stacked: true // Imposta le barre impilate sull'asse x
                    }],
                    yAxes: [{
                        stacked: true // Imposta le barre impilate sull'asse y
                    }]
                }
            }
        });

        var hourlyChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: labels2,
                datasets: [
                    {
                        label: 'Media Valore 1',
                        data: data2_1,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Media Valore 2',
                        data: data2_2,
                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                scales: {
                    xAxes: [{
                        stacked: true // Imposta le barre impilate sull'asse x
                    }],
                    yAxes: [{
                        stacked: true // Imposta le barre impilate sull'asse y
                    }]
                }
            }
        });

        // Funzione per aggiornare il grafico dei valori istantanei
        function updateInstantChart() {
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    labels1.length = 0;
                    data1_1.length = 0;
                    data1_2.length = 0;
                    data.forEach(point => {
                        labels1.push(point.timestamp);
                        data1_1.push(point.value1);
                        data1_2.push(point.value2);
                    });
                    instantChart.update();
                });
        }

        // Funzione per aggiornare il grafico delle medie orarie
        function updateHourlyChart() {
            fetch('/hourlyAverages')
                .then(response => response.json())
                .then(data => {
                    labels2.length = 0;
                    data2_1.length = 0;
                    data2_2.length = 0;
                    data.forEach(point => {
                        labels2.push(point.timestamp);
                        data2_1.push(point.value1);
                        data2_2.push(point.value2);
                    });
                    hourlyChart.update();
                });
        }

        // Aggiorna i grafici all'avvio
        updateInstantChart();
        updateHourlyChart();

        // Connessione WebSocket
        var socket = new WebSocket('ws://' + window.location.hostname + ':81/');

        socket.onmessage = function(event) {
            var message = event.data;
            try {
                var hourlyData = JSON.parse(message);
                if (hourlyData.timestamp && hourlyData.value1 !== undefined && hourlyData.value2 !== undefined) {
                    // Aggiungi i nuovi valori all'inizio e rimuovi i più vecchi
                    labels2.unshift(hourlyData.timestamp);
                    data2_1.unshift(hourlyData.value1);
                    data2_2.unshift(hourlyData.value2);

                    if (labels2.length > 30) {
                        labels2.pop();
                        data2_1.pop();
                        data2_2.pop();
                    }

                    // Aggiorna il grafico delle medie orarie
                    hourlyChart.update();
                }
            } catch (e) {
                var values = message.split(',');
                if (values.length === 2) {
                    var label = new Date().toLocaleTimeString();  // Usa l'ora attuale come etichetta
                    var value1 = parseFloat(values[0]);
                    var value2 = parseFloat(values[1]);

                    // Aggiungi i nuovi valori all'inizio e rimuovi i più vecchi
                    labels1.unshift(label);
                    data1_1.unshift(value1);
                    data1_2.unshift(value2);

                    if (labels1.length > 30) {
                        labels1.pop();
                        data1_1.pop();
                        data1_2.pop();
                    }

                    // Aggiorna il grafico dei valori istantanei
                    instantChart.update();
                }
            }
        };
    </script>
</body>
</html>
